@echo off
chcp 65001 >nul
color 0A
echo.
echo ???????????????????????????????????????????????????????????????????????????
echo    ?? CREAR VERSIÓN PORTABLE COMPLETA - TODO EN UNO
echo ???????????????????????????????????????????????????????????????????????????
echo.
echo Este script realizará los siguientes pasos:
echo   1. ? Limpiar compilaciones anteriores
echo   2. ?? Compilar el proyecto
echo   3. ?? Publicar versión portable
echo   4. ?? Generar archivo LEEME.txt
echo   5. ???  Comprimir en archivo ZIP
echo.
echo ???????????????????????????????????????????????????????????????????????????
echo.
pause

REM ???????????????????????????????????????????????????????????????????????????
REM PASO 1: LIMPIAR
REM ???????????????????????????????????????????????????????????????????????????
echo.
echo ???????????????????????????????????????????????????????????????????????????
echo [1/5] ?? LIMPIANDO COMPILACIONES ANTERIORES...
echo ???????????????????????????????????????????????????????????????????????????
echo.

if exist "publish\portable" (
    echo Eliminando carpeta publish\portable...
    rmdir /s /q "publish\portable"
)

echo ? Limpieza completada
timeout /t 2 /nobreak >nul

REM ???????????????????????????????????????????????????????????????????????????
REM PASO 2: COMPILAR
REM ???????????????????????????????????????????????????????????????????????????
echo.
echo ???????????????????????????????????????????????????????????????????????????
echo [2/5] ?? COMPILANDO PROYECTO...
echo ???????????????????????????????????????????????????????????????????????????
echo.

dotnet build restaurante\restaurante.csproj -c Release

if %ERRORLEVEL% NEQ 0 (
    echo.
    echo ? ERROR: Falló la compilación
    echo.
    pause
    exit /b 1
)

echo ? Compilación exitosa
timeout /t 2 /nobreak >nul

REM ???????????????????????????????????????????????????????????????????????????
REM PASO 3: PUBLICAR VERSIÓN PORTABLE
REM ???????????????????????????????????????????????????????????????????????????
echo.
echo ???????????????????????????????????????????????????????????????????????????
echo [3/5] ?? PUBLICANDO VERSIÓN PORTABLE...
echo ???????????????????????????????????????????????????????????????????????????
echo.

dotnet publish restaurante\restaurante.csproj -c Release -r win-x64 --self-contained true -p:PublishSingleFile=false -o publish\portable

if %ERRORLEVEL% NEQ 0 (
    echo.
    echo ? ERROR: Falló la publicación
    echo.
    pause
    exit /b 1
)

echo ? Publicación exitosa
timeout /t 2 /nobreak >nul

REM ???????????????????????????????????????????????????????????????????????????
REM PASO 4: CREAR ARCHIVO LEEME.txt
REM ???????????????????????????????????????????????????????????????????????????
echo.
echo ???????????????????????????????????????????????????????????????????????????
echo [4/5] ?? GENERANDO ARCHIVO LEEME.txt...
echo ???????????????????????????????????????????????????????????????????????????
echo.

(
echo ???????????????????????????????????????????????????????????????????????????
echo     SISTEMA DE RESTAURANTE - VERSIÓN PORTABLE
echo ???????????????????????????????????????????????????????????????????????????
echo.
echo ?? INSTRUCCIONES DE USO
echo ???????????????????????????????????????????????????????????????????????????
echo.
echo 1. EJECUTAR LA APLICACIÓN
echo    ? Hacer doble clic en "restaurante.exe"
echo    ? NO se requiere instalación
echo    ? NO se requiere .NET Framework instalado
echo.
echo 2. PRIMERA EJECUCIÓN
echo    ? Se creará automáticamente la base de datos "restaurante.db"
echo    ? Configure el sistema desde el Panel de Administración
echo    ? Agregue categorías, platillos y mesas
echo.
echo 3. RESPALDO DE DATOS
echo    ? IMPORTANTE: Copiar el archivo "restaurante.db" regularmente
echo    ? Este archivo contiene TODA la información del sistema
echo    ? Para restaurar datos, solo copie el archivo .db de vuelta
echo.
echo ???????????????????????????????????????????????????????????????????????????
echo ?? CARACTERÍSTICAS DEL SISTEMA
echo ???????????????????????????????????????????????????????????????????????????
echo.
echo ? Gestión de Mesas
echo ? Gestión de Pedidos
echo ? Categorías de Platillos con Colores
echo ? Generación de Tickets PDF
echo ? Panel de Administración Completo
echo ? Sistema Portable ^(sin instalación^)
echo.
echo ???????????????????????????????????????????????????????????????????????????
echo ?? REQUISITOS DEL SISTEMA
echo ???????????????????????????????????????????????????????????????????????????
echo.
echo • Sistema Operativo: Windows 7 SP1 o superior ^(64 bits^)
echo • RAM: 512 MB mínimo ^(1 GB recomendado^)
echo • Espacio en disco: 250 MB
echo • Resolución de pantalla: 1024x768 mínimo
echo.
echo ???????????????????????????????????????????????????????????????????????????
echo ?? SOLUCIÓN DE PROBLEMAS
echo ???????????????????????????????????????????????????????????????????????????
echo.
echo PROBLEMA: "No se puede abrir la aplicación"
echo SOLUCIÓN: 
echo    - Asegúrese de tener Windows 7 SP1 o superior
echo    - Verifique que su sistema sea de 64 bits
echo    - Ejecute como administrador
echo.
echo PROBLEMA: "Se perdieron los datos"
echo SOLUCIÓN:
echo    - Busque el archivo "restaurante.db" en un respaldo
echo    - Cópielo en la misma carpeta que restaurante.exe
echo    - Reinicie la aplicación
echo.
echo ???????????????????????????????????????????????????????????????????????????
echo ?? INFORMACIÓN ADICIONAL
echo ???????????????????????????????????????????????????????????????????????????
echo.
echo • Los archivos .dll son necesarios para el funcionamiento
echo   NO LOS ELIMINE
echo.
echo • Puede copiar toda esta carpeta a otra computadora
echo   y funcionará sin problemas
echo.
echo • Para actualizar el sistema, reemplace todos los archivos
echo   EXCEPTO "restaurante.db" ^(para conservar sus datos^)
echo.
echo ???????????????????????????????????????????????????????????????????????????
echo.
echo                         ¡Gracias por usar nuestro sistema!
echo.
echo ???????????????????????????????????????????????????????????????????????????
) > "publish\portable\LEEME.txt"

echo ? Archivo LEEME.txt creado
timeout /t 2 /nobreak >nul

REM ???????????????????????????????????????????????????????????????????????????
REM PASO 5: CREAR ZIP
REM ???????????????????????????????????????????????????????????????????????????
echo.
echo ???????????????????????????????????????????????????????????????????????????
echo [5/5] ???  CREANDO ARCHIVO ZIP...
echo ???????????????????????????????????????????????????????????????????????????
echo.

REM Obtener la fecha actual
for /f "tokens=2 delims==" %%I in ('wmic os get localdatetime /value') do set datetime=%%I
set FECHA=%datetime:~0,4%-%datetime:~4,2%-%datetime:~6,2%

REM Definir nombre del archivo ZIP
set NOMBRE_ZIP=Restaurante_Portable_%FECHA%.zip

REM Eliminar ZIP anterior si existe
if exist "%NOMBRE_ZIP%" (
    del "%NOMBRE_ZIP%"
)

REM Crear el archivo ZIP
powershell -NoProfile -Command "Compress-Archive -Path 'publish\portable\*' -DestinationPath '%NOMBRE_ZIP%' -CompressionLevel Optimal"

if %ERRORLEVEL% EQU 0 (
    echo ? Archivo ZIP creado exitosamente
) else (
    echo ? ERROR: No se pudo crear el archivo ZIP
    pause
    exit /b 1
)

REM ???????????????????????????????????????????????????????????????????????????
REM RESUMEN FINAL
REM ???????????????????????????????????????????????????????????????????????????
echo.
echo.
echo ???????????????????????????????????????????????????????????????????????????
echo ??? PROCESO COMPLETADO EXITOSAMENTE ???
echo ???????????????????????????????????????????????????????????????????????????
echo.
echo ?? VERSIÓN PORTABLE LISTA PARA DISTRIBUIR
echo.
echo ?? Carpeta portable: publish\portable\
echo ?? Archivo ZIP: %NOMBRE_ZIP%
echo.

REM Contar archivos
for /f %%A in ('dir /b /a-d "publish\portable" ^| find /c /v ""') do set CANT_ARCHIVOS=%%A
echo ?? Total de archivos: %CANT_ARCHIVOS%

REM Obtener tamaño del ZIP
for %%A in ("%NOMBRE_ZIP%") do set TAMANIO=%%~zA
set /a TAMANIO_MB=%TAMANIO% / 1048576
echo ?? Tamaño del ZIP: %TAMANIO_MB% MB

echo.
echo ???????????????????????????????????????????????????????????????????????????
echo ?? PRÓXIMOS PASOS:
echo ???????????????????????????????????????????????????????????????????????????
echo.
echo 1. Distribuya el archivo: %NOMBRE_ZIP%
echo 2. Los usuarios deben descomprimir el archivo
echo 3. Ejecutar "restaurante.exe" (doble clic)
echo 4. ¡Listo! No requiere instalación
echo.
echo ???????????????????????????????????????????????????????????????????????????
echo.
echo Presione cualquier tecla para abrir la carpeta publish\portable...
pause >nul

REM Abrir la carpeta
explorer "publish\portable"

echo.
echo ¡Proceso finalizado!
echo.
pause
