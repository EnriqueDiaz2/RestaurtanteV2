using restaurante.Data;
using restaurante.Models;
using System.Text;

namespace restaurante.Forms;

public partial class TicketForm : Form
{
    private RestauranteContext db;
    private Mesa mesa;
    private List<DetallePedido> detalles;
    private decimal descuento;
    private decimal valorDescuento;
    private string tipoDescuento;

    public TicketForm(RestauranteContext context, Mesa mesa, List<DetallePedido> detalles, 
        decimal descuento, decimal valorDescuento, string tipoDescuento)
    {
        this.db = context;
        this.mesa = mesa;
        this.detalles = detalles;
        this.descuento = descuento;
        this.valorDescuento = valorDescuento;
        this.tipoDescuento = tipoDescuento;
        InitializeComponent();
        GenerarTicket();
    }

    private void InitializeComponent()
    {
        this.Text = "Ticket de Venta";
        this.Size = new Size(500, 750);
        this.StartPosition = FormStartPosition.CenterParent;
        this.FormBorderStyle = FormBorderStyle.FixedDialog;
        this.MaximizeBox = false;
        this.BackColor = Color.FromArgb(236, 240, 241);

        Panel panelHeader = new Panel
        {
            Dock = DockStyle.Top,
            Height = 70,
            BackColor = Color.FromArgb(52, 73, 94)
        };

        Label lblTitulo = new Label
        {
            Text = "🎫 TICKET DE VENTA",
            Dock = DockStyle.Fill,
            Font = new Font("Segoe UI", 16, FontStyle.Bold),
            ForeColor = Color.White,
            TextAlign = ContentAlignment.MiddleCenter
        };
        panelHeader.Controls.Add(lblTitulo);

        Panel panelContenido = new Panel
        {
            Dock = DockStyle.Fill,
            Padding = new Padding(15),
            BackColor = Color.White
        };

        TextBox txtTicket = new TextBox
        {
            Name = "txtTicket",
            Dock = DockStyle.Fill,
            Multiline = true,
            ScrollBars = ScrollBars.Vertical,
            Font = new Font("Courier New", 9),
            ReadOnly = true,
            BackColor = Color.White,
            BorderStyle = BorderStyle.None
        };
        panelContenido.Controls.Add(txtTicket);

        Panel panelBotones = new Panel
        {
            Dock = DockStyle.Bottom,
            Height = 80,
            BackColor = Color.White,
            Padding = new Padding(15)
        };

        Button btnImprimir = new Button
        {
            Text = "🖨️ IMPRIMIR",
            Location = new Point(15, 15),
            Size = new Size(210, 50),
            Font = new Font("Segoe UI", 12, FontStyle.Bold),
            BackColor = Color.FromArgb(46, 204, 113),
            ForeColor = Color.White,
            FlatStyle = FlatStyle.Flat,
            Cursor = Cursors.Hand
        };
        btnImprimir.FlatAppearance.BorderSize = 0;
        btnImprimir.Click += BtnImprimir_Click;

        Button btnCerrar = new Button
        {
            Text = "❌ CERRAR",
            Location = new Point(235, 15),
            Size = new Size(210, 50),
            Font = new Font("Segoe UI", 12, FontStyle.Bold),
            BackColor = Color.FromArgb(149, 165, 166),
            ForeColor = Color.White,
            FlatStyle = FlatStyle.Flat,
            Cursor = Cursors.Hand
        };
        btnCerrar.FlatAppearance.BorderSize = 0;
        btnCerrar.Click += (s, e) => this.Close();

        panelBotones.Controls.AddRange(new Control[] { btnImprimir, btnCerrar });

        this.Controls.Add(panelContenido);
        this.Controls.Add(panelBotones);
        this.Controls.Add(panelHeader);
    }

    private void GenerarTicket()
    {
        var txtTicket = this.Controls.Find("txtTicket", true)[0] as TextBox;
        if (txtTicket == null) return;

        var config = db.Configuraciones.FirstOrDefault();
        if (config == null)
        {
            config = new Configuracion { Id = 1 };
        }

        StringBuilder ticket = new StringBuilder();

        // Encabezado - Nombre del restaurante en negrita
        ticket.AppendLine(config.NombreRestaurante);
        ticket.AppendLine(config.Direccion);
        ticket.AppendLine($"Tel: {config.Telefono}");
        ticket.AppendLine();
        ticket.AppendLine("====================================");
        
        // Información de la mesa
        if (mesa.NumeroMesa == 0)
            ticket.AppendLine("MESA: PARA LLEVAR");
        else
            ticket.AppendLine($"MESA: {mesa.NumeroMesa}");

        ticket.AppendLine("Mesero: _________________");
        ticket.AppendLine($"Fecha: {DateTime.Now:dd/MM/yyyy HH:mm}");
        
        ticket.AppendLine("------------------------------------");
        
        // Encabezado de productos
        ticket.AppendLine($"{"ART",-24} {"CANT",4}  {"PRECIO",7}");
        ticket.AppendLine("------------------------------------");

        // Detalles de productos
        decimal subtotal = 0;
        foreach (var detalle in detalles)
        {
            var platillo = detalle.Platillo ?? db.Platillos.Find(detalle.PlatilloId);
            if (platillo != null)
            {
                decimal importe = detalle.Cantidad * detalle.PrecioUnitario;
                subtotal += importe;

                string nombrePlatillo = platillo.NombreCorto;
                if (nombrePlatillo.Length > 24)
                    nombrePlatillo = nombrePlatillo.Substring(0, 24);

                ticket.AppendLine($"{nombrePlatillo,-24} {detalle.Cantidad,4}  ${importe,6:F2}");
            }
        }

        ticket.AppendLine("------------------------------------");

        // Totales
        ticket.AppendLine($"{"",-24} Subtotal: ${subtotal,6:F2}");

        // IVA (0.00%)
        decimal iva = 0;
        ticket.AppendLine($"{"",-24} IVA (0.00%): ${iva,6:F2}");

        // Descuento
        if (descuento > 0)
        {
            string textoDescuento = tipoDescuento == "%" 
                ? $"Descuento ({valorDescuento:F2}%): ${descuento,6:F2}"
                : $"Descuento: ${descuento,6:F2}";
            ticket.AppendLine($"{"",-24} {textoDescuento}");
        }
        else
        {
            ticket.AppendLine($"{"",-24} Descuento (0.00%): ${descuento,6:F2}");
        }

        ticket.AppendLine();
        ticket.AppendLine("====================================");
        
        // Total final
        decimal total = subtotal + iva - descuento;
        ticket.AppendLine($"{"",-16} TOTAL: ${total,6:F2}");
        
        ticket.AppendLine("====================================");
        ticket.AppendLine();
        ticket.AppendLine("Gracias por su compra");

        txtTicket.Text = ticket.ToString();
    }

    private void BtnImprimir_Click(object? sender, EventArgs e)
    {
        try
        {
            var txtTicket = this.Controls.Find("txtTicket", true)[0] as TextBox;
            if (txtTicket != null)
            {
                // Guardar en archivo de texto como simulación de impresión
                string directorio = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments), "Tickets");
                Directory.CreateDirectory(directorio);

                string mesaInfo = mesa.NumeroMesa == 0 ? "ParaLlevar" : $"Mesa{mesa.NumeroMesa}";
                string nombreArchivo = $"Ticket_{mesaInfo}_{DateTime.Now:yyyyMMdd_HHmmss}.txt";
                string rutaCompleta = Path.Combine(directorio, nombreArchivo);

                File.WriteAllText(rutaCompleta, txtTicket.Text);

                var resultado = MessageBox.Show(
                    $"✅ Ticket guardado exitosamente en:\n\n{rutaCompleta}\n\n" +
                    "En un entorno real, esto se enviaría directamente a la impresora térmica.\n\n" +
                    "¿Desea abrir la carpeta de tickets?",
                    "Ticket Generado",
                    MessageBoxButtons.YesNo,
                    MessageBoxIcon.Information);

                if (resultado == DialogResult.Yes)
                {
                    System.Diagnostics.Process.Start("explorer.exe", directorio);
                }
            }
        }
        catch (Exception ex)
        {
            MessageBox.Show($"❌ Error al guardar ticket: {ex.Message}", "Error", 
                MessageBoxButtons.OK, MessageBoxIcon.Error);
        }
    }
}
