using Microsoft.EntityFrameworkCore;
using restaurante.Data;
using restaurante.Models;

namespace restaurante.Forms;

public partial class AdminForm : Form
{
    private RestauranteContext db;

    public AdminForm(RestauranteContext context)
    {
        db = context;
        InitializeComponent();
    }

    private void InitializeComponent()
    {
        this.Text = "Administración";
        this.Size = new Size(900, 650);
        this.StartPosition = FormStartPosition.CenterParent;

        TabControl tabControl = new TabControl
        {
            Dock = DockStyle.Fill
        };

        // Tab de Configuración
        TabPage tabConfiguracion = new TabPage("Configuración");
        CrearTabConfiguracion(tabConfiguracion);

        // Tab de Categorías
        TabPage tabCategorias = new TabPage("Categorías");
        CrearTabCategorias(tabCategorias);

        // Tab de Platillos
        TabPage tabPlatillos = new TabPage("Platillos");
        CrearTabPlatillos(tabPlatillos);

        tabControl.TabPages.AddRange(new TabPage[] { tabConfiguracion, tabCategorias, tabPlatillos });
        this.Controls.Add(tabControl);
    }

    private void CrearTabConfiguracion(TabPage tab)
    {
        Label lblTitulo = new Label
        {
            Text = "CONFIGURACIÓN DEL RESTAURANTE",
            Location = new Point(20, 20),
            Size = new Size(840, 30),
            Font = new Font("Segoe UI", 14, FontStyle.Bold)
        };

        Label lblNombre = new Label
        {
            Text = "Nombre del Restaurante:",
            Location = new Point(20, 70),
            Size = new Size(200, 25),
            Font = new Font("Segoe UI", 10)
        };

        TextBox txtNombre = new TextBox
        {
            Name = "txtNombreRestaurante",
            Location = new Point(230, 70),
            Size = new Size(400, 25),
            Font = new Font("Segoe UI", 10)
        };

        Label lblDireccion = new Label
        {
            Text = "Dirección:",
            Location = new Point(20, 110),
            Size = new Size(200, 25),
            Font = new Font("Segoe UI", 10)
        };

        TextBox txtDireccion = new TextBox
        {
            Name = "txtDireccion",
            Location = new Point(230, 110),
            Size = new Size(400, 25),
            Font = new Font("Segoe UI", 10)
        };

        Label lblTelefono = new Label
        {
            Text = "Teléfono:",
            Location = new Point(20, 150),
            Size = new Size(200, 25),
            Font = new Font("Segoe UI", 10)
        };

        TextBox txtTelefono = new TextBox
        {
            Name = "txtTelefono",
            Location = new Point(230, 150),
            Size = new Size(200, 25),
            Font = new Font("Segoe UI", 10)
        };

        Button btnGuardarConfig = new Button
        {
            Text = "Guardar Configuración",
            Location = new Point(230, 200),
            Size = new Size(200, 40),
            Font = new Font("Segoe UI", 11, FontStyle.Bold),
            BackColor = Color.FromArgb(46, 204, 113),
            ForeColor = Color.White,
            FlatStyle = FlatStyle.Flat
        };
        btnGuardarConfig.Click += BtnGuardarConfig_Click;

        tab.Controls.AddRange(new Control[] { lblTitulo, lblNombre, txtNombre, lblDireccion, txtDireccion, lblTelefono, txtTelefono, btnGuardarConfig });

        // Cargar datos
        var config = db.Configuraciones.FirstOrDefault();
        if (config != null)
        {
            txtNombre.Text = config.NombreRestaurante;
            txtDireccion.Text = config.Direccion;
            txtTelefono.Text = config.Telefono;
        }
    }

    private void CrearTabCategorias(TabPage tab)
    {
        Label lblTitulo = new Label
        {
            Text = "GESTIÓN DE CATEGORÍAS",
            Location = new Point(20, 20),
            Size = new Size(840, 30),
            Font = new Font("Segoe UI", 14, FontStyle.Bold)
        };

        Label lblNombre = new Label
        {
            Text = "Nombre de la Categoría:",
            Location = new Point(20, 70),
            Size = new Size(200, 25),
            Font = new Font("Segoe UI", 10)
        };

        TextBox txtNombreCategoria = new TextBox
        {
            Name = "txtNombreCategoria",
            Location = new Point(230, 70),
            Size = new Size(300, 25),
            Font = new Font("Segoe UI", 10)
        };

        Button btnAgregarCategoria = new Button
        {
            Text = "Agregar Categoría",
            Location = new Point(540, 67),
            Size = new Size(150, 30),
            Font = new Font("Segoe UI", 10, FontStyle.Bold),
            BackColor = Color.FromArgb(46, 204, 113),
            ForeColor = Color.White,
            FlatStyle = FlatStyle.Flat
        };
        btnAgregarCategoria.Click += BtnAgregarCategoria_Click;

        ListBox lstCategorias = new ListBox
        {
            Name = "lstCategorias",
            Location = new Point(20, 120),
            Size = new Size(670, 400),
            Font = new Font("Segoe UI", 10)
        };

        Button btnEliminarCategoria = new Button
        {
            Text = "Eliminar Categoría Seleccionada",
            Location = new Point(20, 530),
            Size = new Size(250, 35),
            Font = new Font("Segoe UI", 10),
            BackColor = Color.FromArgb(231, 76, 60),
            ForeColor = Color.White,
            FlatStyle = FlatStyle.Flat
        };
        btnEliminarCategoria.Click += BtnEliminarCategoria_Click;

        tab.Controls.AddRange(new Control[] { lblTitulo, lblNombre, txtNombreCategoria, btnAgregarCategoria, lstCategorias, btnEliminarCategoria });
        CargarCategorias(lstCategorias);
    }

    private void CrearTabPlatillos(TabPage tab)
    {
        Label lblTitulo = new Label
        {
            Text = "GESTIÓN DE PLATILLOS",
            Location = new Point(20, 20),
            Size = new Size(840, 30),
            Font = new Font("Segoe UI", 14, FontStyle.Bold)
        };

        // Nombre
        Label lblNombre = new Label
        {
            Text = "Nombre Completo:",
            Location = new Point(20, 70),
            Size = new Size(150, 25),
            Font = new Font("Segoe UI", 10)
        };

        TextBox txtNombrePlatillo = new TextBox
        {
            Name = "txtNombrePlatillo",
            Location = new Point(180, 70),
            Size = new Size(300, 25),
            Font = new Font("Segoe UI", 10)
        };

        // Nombre Corto
        Label lblNombreCorto = new Label
        {
            Text = "Nombre Corto:",
            Location = new Point(500, 70),
            Size = new Size(120, 25),
            Font = new Font("Segoe UI", 10)
        };

        TextBox txtNombreCorto = new TextBox
        {
            Name = "txtNombreCorto",
            Location = new Point(620, 70),
            Size = new Size(200, 25),
            Font = new Font("Segoe UI", 10)
        };

        // Precio
        Label lblPrecio = new Label
        {
            Text = "Precio:",
            Location = new Point(20, 110),
            Size = new Size(150, 25),
            Font = new Font("Segoe UI", 10)
        };

        NumericUpDown numPrecio = new NumericUpDown
        {
            Name = "numPrecio",
            Location = new Point(180, 110),
            Size = new Size(120, 25),
            Font = new Font("Segoe UI", 10),
            DecimalPlaces = 2,
            Maximum = 9999,
            Minimum = 0
        };

        // Categoría
        Label lblCategoria = new Label
        {
            Text = "Categoría:",
            Location = new Point(320, 110),
            Size = new Size(80, 25),
            Font = new Font("Segoe UI", 10)
        };

        ComboBox cmbCategoria = new ComboBox
        {
            Name = "cmbCategoria",
            Location = new Point(400, 110),
            Size = new Size(200, 25),
            Font = new Font("Segoe UI", 10),
            DropDownStyle = ComboBoxStyle.DropDownList
        };

        Button btnAgregarPlatillo = new Button
        {
            Text = "Agregar Platillo",
            Location = new Point(620, 107),
            Size = new Size(200, 30),
            Font = new Font("Segoe UI", 10, FontStyle.Bold),
            BackColor = Color.FromArgb(46, 204, 113),
            ForeColor = Color.White,
            FlatStyle = FlatStyle.Flat
        };
        btnAgregarPlatillo.Click += BtnAgregarPlatillo_Click;

        DataGridView dgvPlatillos = new DataGridView
        {
            Name = "dgvPlatillos",
            Location = new Point(20, 160),
            Size = new Size(840, 350),
            Font = new Font("Segoe UI", 9),
            AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill,
            SelectionMode = DataGridViewSelectionMode.FullRowSelect,
            MultiSelect = false,
            ReadOnly = true,
            AllowUserToAddRows = false
        };

        Button btnEliminarPlatillo = new Button
        {
            Text = "Eliminar Platillo Seleccionado",
            Location = new Point(20, 520),
            Size = new Size(250, 35),
            Font = new Font("Segoe UI", 10),
            BackColor = Color.FromArgb(231, 76, 60),
            ForeColor = Color.White,
            FlatStyle = FlatStyle.Flat
        };
        btnEliminarPlatillo.Click += BtnEliminarPlatillo_Click;

        Button btnModificarPlatillo = new Button
        {
            Text = "Modificar Precio",
            Location = new Point(280, 520),
            Size = new Size(150, 35),
            Font = new Font("Segoe UI", 10),
            BackColor = Color.FromArgb(52, 152, 219),
            ForeColor = Color.White,
            FlatStyle = FlatStyle.Flat
        };
        btnModificarPlatillo.Click += BtnModificarPlatillo_Click;

        tab.Controls.AddRange(new Control[] { 
            lblTitulo, lblNombre, txtNombrePlatillo, lblNombreCorto, txtNombreCorto,
            lblPrecio, numPrecio, lblCategoria, cmbCategoria, btnAgregarPlatillo,
            dgvPlatillos, btnEliminarPlatillo, btnModificarPlatillo
        });

        CargarCategoriasCbo(cmbCategoria);
        CargarPlatillos(dgvPlatillos);
    }

    private void BtnGuardarConfig_Click(object? sender, EventArgs e)
    {
        try
        {
            var txtNombre = this.Controls.Find("txtNombreRestaurante", true)[0] as TextBox;
            var txtDireccion = this.Controls.Find("txtDireccion", true)[0] as TextBox;
            var txtTelefono = this.Controls.Find("txtTelefono", true)[0] as TextBox;

            var config = db.Configuraciones.FirstOrDefault();
            if (config == null)
            {
                config = new Configuracion { Id = 1 };
                db.Configuraciones.Add(config);
            }

            config.NombreRestaurante = txtNombre?.Text ?? "";
            config.Direccion = txtDireccion?.Text ?? "";
            config.Telefono = txtTelefono?.Text ?? "";

            db.SaveChanges();
            MessageBox.Show("Configuración guardada correctamente.", "Éxito", MessageBoxButtons.OK, MessageBoxIcon.Information);
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Error: {ex.Message}", "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
        }
    }

    private void BtnAgregarCategoria_Click(object? sender, EventArgs e)
    {
        var txtNombre = this.Controls.Find("txtNombreCategoria", true)[0] as TextBox;
        if (string.IsNullOrWhiteSpace(txtNombre?.Text))
        {
            MessageBox.Show("Ingrese un nombre para la categoría.", "Aviso", MessageBoxButtons.OK, MessageBoxIcon.Warning);
            return;
        }

        try
        {
            var categoria = new Categoria
            {
                Nombre = txtNombre.Text.Trim()
            };

            db.Categorias.Add(categoria);
            db.SaveChanges();

            txtNombre.Clear();
            var lstCategorias = this.Controls.Find("lstCategorias", true)[0] as ListBox;
            if (lstCategorias != null)
                CargarCategorias(lstCategorias);

            MessageBox.Show("Categoría agregada correctamente.", "Éxito", MessageBoxButtons.OK, MessageBoxIcon.Information);
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Error: {ex.Message}", "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
        }
    }

    private void BtnEliminarCategoria_Click(object? sender, EventArgs e)
    {
        var lstCategorias = this.Controls.Find("lstCategorias", true)[0] as ListBox;
        if (lstCategorias?.SelectedItem == null)
        {
            MessageBox.Show("Seleccione una categoría para eliminar.", "Aviso", MessageBoxButtons.OK, MessageBoxIcon.Warning);
            return;
        }

        var categoriaItem = lstCategorias.SelectedItem.ToString();
        var categoriaId = int.Parse(categoriaItem!.Split('-')[0].Trim());

        // Verificar si tiene platillos
        var tienePlatillos = db.Platillos.Any(p => p.CategoriaId == categoriaId);
        if (tienePlatillos)
        {
            MessageBox.Show("No se puede eliminar la categoría porque tiene platillos asociados.", "Aviso", MessageBoxButtons.OK, MessageBoxIcon.Warning);
            return;
        }

        var resultado = MessageBox.Show("¿Está seguro de eliminar esta categoría?", "Confirmar", MessageBoxButtons.YesNo, MessageBoxIcon.Question);
        if (resultado == DialogResult.Yes)
        {
            try
            {
                var categoria = db.Categorias.Find(categoriaId);
                if (categoria != null)
                {
                    db.Categorias.Remove(categoria);
                    db.SaveChanges();
                    CargarCategorias(lstCategorias);
                    MessageBox.Show("Categoría eliminada correctamente.", "Éxito", MessageBoxButtons.OK, MessageBoxIcon.Information);
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Error: {ex.Message}", "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }
    }

    private void BtnAgregarPlatillo_Click(object? sender, EventArgs e)
    {
        var txtNombre = this.Controls.Find("txtNombrePlatillo", true)[0] as TextBox;
        var txtNombreCorto = this.Controls.Find("txtNombreCorto", true)[0] as TextBox;
        var numPrecio = this.Controls.Find("numPrecio", true)[0] as NumericUpDown;
        var cmbCategoria = this.Controls.Find("cmbCategoria", true)[0] as ComboBox;

        if (string.IsNullOrWhiteSpace(txtNombre?.Text) || string.IsNullOrWhiteSpace(txtNombreCorto?.Text))
        {
            MessageBox.Show("Complete todos los campos.", "Aviso", MessageBoxButtons.OK, MessageBoxIcon.Warning);
            return;
        }

        if (cmbCategoria?.SelectedValue == null)
        {
            MessageBox.Show("Seleccione una categoría.", "Aviso", MessageBoxButtons.OK, MessageBoxIcon.Warning);
            return;
        }

        try
        {
            var platillo = new Platillo
            {
                Nombre = txtNombre.Text.Trim(),
                NombreCorto = txtNombreCorto.Text.Trim(),
                Precio = numPrecio?.Value ?? 0,
                CategoriaId = (int)cmbCategoria.SelectedValue
            };

            db.Platillos.Add(platillo);
            db.SaveChanges();

            txtNombre.Clear();
            txtNombreCorto.Clear();
            numPrecio.Value = 0;

            var dgvPlatillos = this.Controls.Find("dgvPlatillos", true)[0] as DataGridView;
            if (dgvPlatillos != null)
                CargarPlatillos(dgvPlatillos);

            MessageBox.Show("Platillo agregado correctamente.", "Éxito", MessageBoxButtons.OK, MessageBoxIcon.Information);
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Error: {ex.Message}", "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
        }
    }

    private void BtnEliminarPlatillo_Click(object? sender, EventArgs e)
    {
        var dgvPlatillos = this.Controls.Find("dgvPlatillos", true)[0] as DataGridView;
        if (dgvPlatillos?.CurrentRow == null)
        {
            MessageBox.Show("Seleccione un platillo para eliminar.", "Aviso", MessageBoxButtons.OK, MessageBoxIcon.Warning);
            return;
        }

        var resultado = MessageBox.Show("¿Está seguro de eliminar este platillo?", "Confirmar", MessageBoxButtons.YesNo, MessageBoxIcon.Question);
        if (resultado == DialogResult.Yes)
        {
            try
            {
                int platilloId = (int)dgvPlatillos.CurrentRow.Cells["Id"].Value;
                var platillo = db.Platillos.Find(platilloId);
                if (platillo != null)
                {
                    db.Platillos.Remove(platillo);
                    db.SaveChanges();
                    CargarPlatillos(dgvPlatillos);
                    MessageBox.Show("Platillo eliminado correctamente.", "Éxito", MessageBoxButtons.OK, MessageBoxIcon.Information);
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Error: {ex.Message}", "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }
    }

    private void BtnModificarPlatillo_Click(object? sender, EventArgs e)
    {
        var dgvPlatillos = this.Controls.Find("dgvPlatillos", true)[0] as DataGridView;
        if (dgvPlatillos?.CurrentRow == null)
        {
            MessageBox.Show("Seleccione un platillo para modificar.", "Aviso", MessageBoxButtons.OK, MessageBoxIcon.Warning);
            return;
        }

        try
        {
            int platilloId = (int)dgvPlatillos.CurrentRow.Cells["Id"].Value;
            var platillo = db.Platillos.Find(platilloId);
            if (platillo != null)
            {
                string? nuevoPrecioStr = Microsoft.VisualBasic.Interaction.InputBox(
                    $"Ingrese el nuevo precio para: {platillo.Nombre}\nPrecio actual: ${platillo.Precio:F2}",
                    "Modificar Precio",
                    platillo.Precio.ToString());

                if (!string.IsNullOrWhiteSpace(nuevoPrecioStr) && decimal.TryParse(nuevoPrecioStr, out decimal nuevoPrecio))
                {
                    platillo.Precio = nuevoPrecio;
                    db.SaveChanges();
                    CargarPlatillos(dgvPlatillos);
                    MessageBox.Show("Precio modificado correctamente.", "Éxito", MessageBoxButtons.OK, MessageBoxIcon.Information);
                }
            }
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Error: {ex.Message}", "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
        }
    }

    private void CargarCategorias(ListBox lst)
    {
        lst.Items.Clear();
        var categorias = db.Categorias.OrderBy(c => c.Nombre).ToList();
        foreach (var cat in categorias)
        {
            lst.Items.Add($"{cat.Id} - {cat.Nombre}");
        }
    }

    private void CargarCategoriasCbo(ComboBox cmb)
    {
        var categorias = db.Categorias.OrderBy(c => c.Nombre).ToList();
        cmb.DataSource = categorias;
        cmb.DisplayMember = "Nombre";
        cmb.ValueMember = "Id";
    }

    private void CargarPlatillos(DataGridView dgv)
    {
        var platillos = db.Platillos
            .Include(p => p.Categoria)
            .Select(p => new
            {
                p.Id,
                p.Nombre,
                p.NombreCorto,
                Precio = p.Precio,
                Categoria = p.Categoria!.Nombre
            })
            .ToList();

        dgv.DataSource = platillos;
        
        if (dgv.Columns["Id"] != null)
            dgv.Columns["Id"]!.Visible = false;
    }
}
